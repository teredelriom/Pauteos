<!DOCTYPE html>
<html lang="es" class="antialiased" data-theme="pink">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Pauteo Pro v5.1 (Fixed)</title>

<meta name="application-name" content="Pauteo">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#ff8ec0">
<meta name="description" content="Plataforma de estudio m√©dico modular con IA y SRS.">

<link rel="icon" id="dynamic-favicon" href='data:image/svg+xml,<svg width="512" height="512" viewBox="0 0 512 512" fill="none" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g" x1="0" y1="0" x2="512" y2="512" gradientUnits="userSpaceOnUse"><stop offset="0%" stop-color="%23FF9A9E"/><stop offset="100%" stop-color="%23FECFEF"/></linearGradient></defs><rect x="0" y="0" width="512" height="512" rx="120" fill="url(%23g)"/><rect x="106" y="106" width="300" height="300" rx="40" fill="white"/><path d="M160 256 L210 306 L240 210 L270 280 L352 180" stroke="%23FF758C" stroke-width="32" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg>'>
<link rel="apple-touch-icon" id="dynamic-apple-icon" href='data:image/svg+xml,<svg width="512" height="512" viewBox="0 0 512 512" fill="none" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g" x1="0" y1="0" x2="512" y2="512" gradientUnits="userSpaceOnUse"><stop offset="0%" stop-color="%23FF9A9E"/><stop offset="100%" stop-color="%23FECFEF"/></linearGradient></defs><rect x="0" y="0" width="512" height="512" rx="120" fill="url(%23g)"/><rect x="106" y="106" width="300" height="300" rx="40" fill="white"/><path d="M160 256 L210 306 L240 210 L270 280 L352 180" stroke="%23FF758C" stroke-width="32" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg>'>
<link rel="manifest" id="my-manifest">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Material+Icons" rel="stylesheet">

<style>
/* --- 1. VARIABLES --- */
:root {
  --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --muted: #64748b; --border: #e2e8f0;
  --primary: #ec4899; --primary-soft: #fce7f3; --primary-hover: #db2777;
  --success-bg: #dcfce7; --success-text: #166534; --success-border: #86efac;
  --error-bg: #fee2e2; --error-text: #991b1b; --error-border: #fca5a5;
  --warn-bg: #fff7ed; --warn-text: #9a3412; --warn-border: #fdba74;
  --case-accent: #0ea5e9; --case-soft: #e0f2fe;
  --radius: 16px; 
  --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
}
[data-theme='pink'] { --primary: #ec4899; --primary-soft: #fce7f3; }
[data-theme='light'] { --bg: #f3f4f6; --primary: #3b82f6; --primary-soft: #dbeafe; }
[data-theme='dark'] { --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --muted: #94a3b8; --border: #334155; --primary: #38bdf8; --primary-soft: #0c4a6e; --success-bg: #064e3b; --error-bg: #7f1d1d; --case-soft: #0c4a6e; --shadow: 0 10px 15px -3px rgba(0,0,0,0.5); }

html, body { height:100%; min-height:100dvh; margin:0; font-family:'Inter', sans-serif; background:var(--bg); color:var(--text); -webkit-tap-highlight-color: transparent; transition: background 0.3s, color 0.3s; }
* { box-sizing: border-box; }

/* --- 2. LAYOUT --- */
.app { max-width: 1200px; margin: 0 auto; padding: 20px; display: grid; grid-template-columns: 320px 1fr; gap: 24px; min-height: 100vh; padding-bottom: 80px; }
body.quiz-mode .app { grid-template-columns: 1fr; padding-top: 10px; }
body.quiz-mode aside#left-panel { display: none !important; }
body.quiz-mode #quiz-menu-btn { display: inline-flex !important; }
@media(max-width: 980px){ .app { grid-template-columns: 1fr; padding: 12px; } aside#left-panel { display: none; } #mobile-menu-btn { display: flex; } }

/* --- 3. COMPONENTES UI --- */
.card { background: var(--card); border-radius: var(--radius); padding: 24px; box-shadow: var(--shadow); border: 1px solid var(--border); position: relative; }
.btn { background: var(--primary-soft); color: var(--primary); border-radius: 12px; padding: 10px 16px; border: none; cursor: pointer; font-weight: 600; font-size: 0.9rem; display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s; gap: 6px; }
.btn:hover { transform: translateY(-1px); filter: brightness(0.95); }
.btn:active { transform: scale(0.96); }
.btn.primary { background: var(--primary); color: white; }
.btn.outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
.btn.small { padding: 6px 12px; font-size: 0.8rem; border-radius: 8px; }
.btn.active-mode { background: var(--primary); color: white; border-color: var(--primary); }

.input { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--text); outline: none; font-size: 0.95rem; }
.input:focus { border-color: var(--primary); }

.tag-pill { display: inline-block; padding: 4px 10px; border-radius: 99px; background: var(--primary-soft); color: var(--primary); font-size: 0.75rem; font-weight: 600; margin-right: 6px; margin-bottom: 4px; cursor: pointer; border: 1px solid transparent; }
.tag-pill:hover, .tag-pill.active { background: var(--primary); color: white; }

.icon-btn { display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; width: 36px; height: 36px; border: 1px solid var(--border); cursor: pointer; background: var(--card); color: var(--muted); }
.icon-btn:hover { background: var(--primary-soft); color: var(--primary); border-color: var(--primary); }

.block-header { font-weight: 700; font-size: 0.85rem; text-transform: uppercase; color: var(--muted); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
.flex-between { display: flex; justify-content: space-between; align-items: center; }
.text-muted { color: var(--muted); }

/* Quiz & Answers */
.answer-card { padding: 16px; border-radius: 12px; border: 1px solid var(--border); background: var(--card); cursor: pointer; margin-bottom: 10px; display: flex; gap: 12px; align-items: flex-start; transition: 0.2s; }
.answer-card:hover { transform: translateY(-2px); border-color: var(--primary); }
.answer-card.correct { background: var(--success-bg) !important; border-color: var(--success-border) !important; color: var(--success-text); }
.answer-card.incorrect { background: var(--error-bg) !important; border-color: var(--error-border) !important; color: var(--error-text); }
.answer-card.disabled { opacity: 0.9; pointer-events: none; }
.answer-card.selected-blind { border: 2px solid var(--primary); background: var(--primary-soft); }

#question-text { font-size: 1.15rem; line-height: 1.6; font-weight: 500; margin-bottom: 1.5rem; white-space: pre-wrap; }
.question-img { max-width: 100%; max-height: 350px; border-radius: 8px; object-fit: contain; margin: 0 auto 16px; display: block; border: 1px solid var(--border); cursor: zoom-in; }

.progress-bg { background: var(--border); border-radius: 99px; height: 8px; overflow: hidden; }
.progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.4s ease; }

/* Cases */
.srs-controls { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-top: 20px; }
.srs-btn { display: flex; flex-direction: column; align-items: center; padding: 12px; border-radius: 12px; border: 1px solid transparent; cursor: pointer; }
.srs-hard { background: var(--error-bg); color: var(--error-text); border-color: var(--error-border); }
.srs-good { background: #e0f2fe; color: #0369a1; border-color: #7dd3fc; }
.srs-easy { background: var(--success-bg); color: var(--success-text); border-color: var(--success-border); }
.notepad { width: 100%; min-height: 120px; padding: 12px; border-radius: 8px; border: 1px solid #fcd34d; background: #fffbeb; color: #78350f; font-family: monospace; resize: vertical; margin-top: 10px; }
[data-theme='dark'] .notepad { background: #2a2515; border-color: #854d0e; color: #fde68a; }

/* Drawer & Modals */
.drawer { position: fixed; left: -360px; top: 0; bottom: 0; width: 340px; background: var(--card); z-index: 2000; transition: left 0.3s; box-shadow: 5px 0 25px rgba(0,0,0,0.1); padding: 20px; overflow-y: auto; border-right: 1px solid var(--border); }
.drawer.open { left: 0; }
.overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 1500; display: none; align-items: center; justify-content: center; }
.overlay.open { display: flex; }
.modal { background: var(--card); width: 90%; max-width: 600px; max-height: 90vh; border-radius: var(--radius); padding: 24px; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
#drop-zone, #cases-drop-zone { border: 2px dashed var(--border); border-radius: var(--radius); padding: 32px; text-align: center; color: var(--muted); cursor: pointer; transition: 0.2s; }
#drop-zone:hover { border-color: var(--primary); background: var(--primary-soft); color: var(--primary); }

.nav-grid { display: flex; flex-wrap: wrap; gap: 6px; max-height: 250px; overflow-y: auto; margin-top: 10px; }
.nav-dot { width: 30px; height: 30px; border-radius: 50%; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid var(--border); background: var(--bg); }
.nav-dot.current { border: 2px solid var(--primary); font-weight: bold; }
.nav-dot.answered { background: var(--primary-soft); color: var(--primary); border-color: transparent; }
.nav-dot.wrong { background: var(--error-bg); color: var(--error-text); }
.nav-dot.flagged { border-color: var(--warn-border); color: var(--warn-text); background: var(--warn-bg); }

.search-results { position: absolute; top: 100%; left: 0; right: 0; background: var(--card); border: 1px solid var(--border); border-radius: 8px; z-index: 100; max-height: 200px; overflow-y: auto; display: none; box-shadow: var(--shadow); }
.search-item { padding: 8px 12px; border-bottom: 1px solid var(--border); cursor: pointer; font-size: 0.85rem; }
.search-item:hover { background: var(--primary-soft); }

/* Tutorial Styles */
.tutorial-section { margin-bottom: 24px; }
.tutorial-title { font-weight: 700; color: var(--primary); margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
.key-badge { display: inline-block; padding: 2px 6px; border: 1px solid var(--border); border-radius: 4px; font-family: monospace; font-size: 0.8rem; background: var(--bg); }

</style>
</head>
<body>

<div class="app" id="app-root">
  
  <aside id="left-panel" class="card" style="height: fit-content; min-height: 80vh; display:flex; flex-direction:column; gap: 16px;">
    
    <div class="flex-between">
      <div>
        <h2 style="margin:0; font-size:1.4rem;">Pauteo Pro</h2>
        <div class="small text-muted">v5.1 ¬∑ <span style="color:var(--primary)">Ultimate</span></div>
      </div>
      <div style="display:flex; gap:8px;">
          <button id="tutorial-btn" class="icon-btn" title="Ayuda"><span class="material-icons">info</span></button>
          <button id="download-app-btn" class="icon-btn" title="Instalar App" style="display:none;"><span class="material-icons">install_mobile</span></button>
      </div>
    </div>

    <div style="position:relative;">
        <input id="search-bar" class="input" placeholder="Buscar pregunta..." autocomplete="off" />
        <div id="sidebar-search-results" class="search-results"></div>
    </div>

    <div>
      <div class="block-header"><span class="material-icons" style="font-size:16px;">quiz</span> MODOS</div>
      <div style="display:flex; gap:8px; margin-bottom:12px;">
        <button id="mode-study" class="btn outline" style="flex:1">Estudio</button>
        <button id="mode-exam" class="btn outline" style="flex:1">Ensayo</button>
        <button id="mode-pauteo" class="btn outline" style="flex:1">Pauteo</button>
    </div>
        <div>
      <div class="block-header"><span class="material-icons" style="font-size:16px;">timer</span> ENSAYO</div>
      
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-bottom:8px;">
        <div style="position:relative;">
            <span class="material-icons" style="position:absolute; left:10px; top:50%; transform:translateY(-50%); font-size:16px; color:var(--muted); pointer-events:none;">format_list_numbered</span>
            <input id="q-count-input" type="number" placeholder="Todas" title="N¬∞ Preguntas" class="input" style="padding-left:34px; text-align:center; font-weight:500;">
        </div>
        
        <div style="position:relative;">
            <span class="material-icons" style="position:absolute; left:10px; top:50%; transform:translateY(-50%); font-size:16px; color:var(--muted); pointer-events:none;">schedule</span>
            <input id="timer-input" type="number" value="30" title="Minutos" class="input" style="padding-left:34px; text-align:center; font-weight:500;">
        </div>
      </div>

      <button id="start-exam" class="btn primary" style="width:100%; justify-content:center; gap:8px;">
        <span class="material-icons" style="font-size:18px;">play_arrow</span> Iniciar Ensayo
      </button>
    </div>

    <hr style="border:0; border-top:1px solid var(--border); width:100%;">

    <div style="flex:1; display:flex; flex-direction:column; min-height:0;">
       <div class="block-header">
           <span class="material-icons" style="font-size:16px;">folder_open</span> BANCOS
           <div style="margin-left:auto; display:flex; gap:4px;">
                <button id="clean-duplicates-btn" class="btn small outline" title="Limpiar Duplicados"><span class="material-icons" style="font-size:14px;">cleaning_services</span></button>
                <button id="btn-merge-ui" class="btn small outline" title="Fusionar"><span class="material-icons" style="font-size:14px;">merge</span></button>
           </div>
       </div>
       <div id="banks-list" style="flex:1; overflow-y:auto; margin-bottom:12px; padding-right:4px;"></div>
       <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-bottom:8px;">
            <button id="save-bank-btn" class="btn small outline">Guardar Nuevo</button>
            <button id="update-bank-btn" class="btn small outline">Actualizar</button>
       </div>
       <button id="export-json-btn" class="btn small outline" style="width:100%; margin-top:4px;">Exportar JSON</button></div>
       <div style="font-size:0.75rem; color:var(--muted); text-align:center;">Activo: <span id="active-bank" style="color:var(--primary); font-weight:600;">(ninguno)</span>
       </div>
       

    <hr style="border:0; border-top:1px solid var(--border); width:100%;">

    <div>
        <div class="block-header"><span class="material-icons" style="font-size:16px;">upload_file</span> IMPORTAR</div>
        <div id="drop-zone" style="padding:16px;">
            <span class="material-icons" style="font-size:24px; color:var(--primary);">cloud_upload</span>
            <div style="font-size:0.8rem; margin-top:4px;">Arrastra JSON o TXT</div>
        </div>
        <input id="file-input" type="file" accept=".json,.txt,.csv" multiple style="display:none" />
        <div style="display:flex; gap:8px; margin-top:12px;">
             <button id="btn-ai-config" class="btn small outline" style="flex:1;">Config IA</button>
             <button id="btn-ai-tags-bank" class="btn small" style="flex:1; background:var(--primary-soft);">Tags IA</button>
        </div>
        <button id="btn-show-templates" class="btn small outline" style="width:100%; margin-top:8px; border-style:dashed;">
            <span class="material-icons" style="font-size:14px; margin-right:6px;">data_object</span> Ver Plantillas JSON
        </button>
    </div>

    <div style="display:flex; gap:6px; justify-content:center; margin-top:8px;">
        <button class="icon-btn" onclick="setTheme('pink')" style="background:#fce7f3;"></button>
        <button class="icon-btn" onclick="setTheme('light')" style="background:#f3f4f6;"></button>
        <button class="icon-btn" onclick="setTheme('dark')" style="background:#1e293b; border-color:#334155;"></button>
    </div>
  </aside>

  <main id="main-panel" style="height:100%; display:flex; flex-direction:column;">

    <div id="dashboard-view" style="display:flex; flex-direction:column; gap:24px;">
        <div class="card" style="text-align:center; padding: 40px 20px;">
            <div style="display:flex; justify-content:space-between; position:absolute; top:20px; left:20px; right:20px;">
                <button id="mobile-menu-btn" class="icon-btn" style="display:none;"><span class="material-icons">menu</span></button>
                <div id="filter-badge-area"></div>
            </div>
            <h1 style="font-size:2rem; margin-bottom:8px;">Listo para aprender</h1>
            <p class="text-muted" style="margin-bottom:32px;">Selecciona tu modo de entrenamiento.</p>
            <div style="display:flex; justify-content:center; gap:16px; flex-wrap:wrap;">
                <button id="open-pauteo-btn" class="btn primary" style="padding:14px 28px; font-size:1rem; box-shadow: 0 4px 14px rgba(236, 72, 153, 0.4);">
                    <span class="material-icons">play_arrow</span> Iniciar Quiz
                </button>
                <button id="open-smart-btn" class="btn outline" style="padding:14px 28px; font-size:1rem;">
                    <span class="material-icons">school</span> Repaso Inteligente
                </button>
            </div>
            <div style="margin-top:24px;">
                <button id="open-cases-module-btn" class="btn" style="background:var(--case-soft); color:var(--case-accent); border:1px solid var(--case-accent); padding:12px 24px;">
                    <span class="material-icons">medical_services</span> M√≥dulo Casos Cl√≠nicos
                </button>
            </div>
        </div>

        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:24px;">
            <div class="card">
                <div class="block-header"><span class="material-icons">bar_chart</span> RENDIMIENTO</div>
                <div id="history-chart" style="display:flex; align-items:flex-end; height:120px; gap:8px;"></div>
            </div>
            <div class="card">
                <div class="block-header">
                    <span class="material-icons">local_offer</span> TEMAS
                    <button id="open-editor-hero-btn" class="btn small outline" style="margin-left:auto;">Filtro Avanzado</button>
                </div>
                <div id="start-tags-list" style="display:flex; flex-wrap:wrap; gap:6px;"></div>
            </div>
        </div>
        
        <div id="dashboard-marked-card" class="card" style="display:none; border-left:4px solid var(--gold);">
            <div class="block-header"><span class="material-icons" style="color:var(--gold)">star</span> MARCADAS RECIENTES</div>
            <div id="dashboard-marked-list" style="display:flex; flex-direction:column; gap:8px;"></div>
        </div>
    </div>

    <div id="quiz-view" class="card" style="display:none; height:100%; flex-direction:column; padding:0; border:none; background:transparent; box-shadow:none;">
        <div class="flex-between" style="margin-bottom:16px;">
            <button id="quiz-menu-btn" class="icon-btn" style="display:none;"><span class="material-icons">menu</span></button>
            <div style="width: 100%; max-width: 600px; margin: 0 12px; flex:1;">
                <div class="flex-between" style="margin-bottom:4px;">
                    <span id="progress-text" class="small font-bold">1 / 10</span>
                    <span id="timer-display" class="small font-bold" style="color:var(--primary);"></span>
                </div>
                <div class="progress-bg"><div id="progress-bar" class="progress-fill"></div></div>
            </div>
            <button onclick="closeQuizView()" class="btn small outline">Salir</button>
        </div>

        

        <div id="quiz-shell" style="flex:1; display:flex; flex-direction:column;">
             <div class="card" style="max-width:800px; margin:0 auto; width:100%; flex:1; display:flex; flex-direction:column;">
                <div class="flex-between" style="margin-bottom:16px;">
                    <div id="question-tags"></div>
                    <div style="display:flex; gap:6px;">
                        <button id="edit-q-btn" class="icon-btn" title="Editar"><span class="material-icons" style="font-size:18px;">edit</span></button>
                        <button id="flag-btn" class="icon-btn" title="Duda"><span class="material-icons" style="font-size:18px;">outlined_flag</span></button>
                        <button id="star-btn" class="icon-btn" title="Favorito"><span class="material-icons" style="font-size:18px;">star_border</span></button>
                    </div>
                </div>

                <div id="edit-form-container" style="display:none; margin-bottom:20px; padding:12px; background:var(--bg); border:1px solid var(--primary); border-radius:12px;">
                     <label class="small font-bold">Pregunta:</label>
                     <textarea id="edit-q-text" class="input" rows="3" style="margin-bottom:8px;"></textarea>
                     <label class="small font-bold">Imagen URL:</label>
                     <input type="text" id="edit-q-image" class="input" style="margin-bottom:8px;">
                     <label class="small font-bold">Alternativas:</label>
                     <div id="edit-answers-list" style="display:grid; gap:6px; margin-bottom:8px;"></div>
                     <label class="small font-bold">Correcta (0=A, 1=B...):</label>
                     <input type="number" id="edit-correct-idx" class="input" style="width:60px;">
                     <div style="text-align:right; margin-top:8px;">
                        <button id="save-edit-btn" class="btn primary">Guardar</button>
                     </div>
                </div>

                <div style="flex:1;">
                    <div id="question-image-container"></div>
                    <div id="question-text"></div>
                    <div id="answers"></div>
                    <details id="justification-box" style="margin-top:20px; display:none; border:1px solid var(--border); border-radius:8px; padding:8px;">
                        <summary style="cursor:pointer; font-weight:bold; color:var(--primary);">Explicaci√≥n</summary>
                        <div id="justification-text" style="padding-top:8px; line-height:1.6;"></div>
                    </details>
                </div>

                <div class="flex-between" style="margin-top:24px; padding-top:16px; border-top:1px solid var(--border);">
                    <button id="prev-btn" class="btn outline">Anterior</button>
                    <div style="display:flex; gap:12px;">
                        <button id="restart-btn" class="btn outline">Reiniciar</button>
                        <button id="next-btn" class="btn primary">Siguiente</button>
                    </div>
                </div>
                <div style="text-align:center; margin-top:8px;">
                    <button id="show-results-btn" style="background:none; border:none; text-decoration:underline; cursor:pointer; font-size:0.8rem; color:var(--muted);">Finalizar</button>
                </div>
             </div>
        </div>

        <div id="results-panel" class="card" style="display:none; max-width:600px; margin:0 auto; text-align:center;">
             <h2 style="font-size:1.8rem;">Resultados</h2>
             <div id="score-text" style="font-size:1.2rem; margin-bottom:20px; color:var(--primary); font-weight:700;"></div>
             <button id="retry-incorrect-btn" class="btn" style="background:var(--error-bg); color:var(--error-text); width:100%; justify-content:center; margin-bottom:12px; display:none;">Reintentar Errores</button>
             <div id="results-list" style="text-align:left; max-height:400px; overflow-y:auto; margin-bottom:20px;"></div>
             <button onclick="location.reload()" class="btn outline">Volver al Inicio</button>
        </div>
    </div>

    <div id="cases-view" style="display:none; height:100%; flex-direction:column; gap: 20px;">
        <div class="flex-between">
             <button onclick="exitCasesModule()" class="btn small outline"><span class="material-icons" style="font-size:16px;">arrow_back</span> Dashboard</button>
             <h2 class="font-bold" style="color:var(--case-accent); margin:0;">Casos Cl√≠nicos SRS</h2>
        </div>

        <div id="cases-import-screen" class="card" style="text-align:center; padding:60px 20px; border: 2px dashed var(--case-accent);">
            <div style="width:60px; height:60px; background:var(--case-soft); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 16px;">
                <span class="material-icons" style="font-size:32px; color:var(--case-accent);">medical_services</span>
            </div>
            <h3 class="font-bold text-xl">Carga tus Casos</h3>
            <p class="text-muted mb-6">Arrastra un archivo JSON compatible aqu√≠.</p>
            <div id="cases-drop-zone" style="margin-bottom:16px; padding:20px; background:var(--bg); border-radius:12px;">Elegir archivo</div>
            <input id="cases-file-input" type="file" accept=".json" style="display:none" />
        </div>

        <div id="cases-study-screen" style="display:none; flex-direction:column; flex:1; overflow-y: auto;">
            <div style="width:100%; max-width:600px; margin:0 auto 10px;">
                <div class="flex-between" style="margin-bottom:4px;">
                    <span id="cases-progress-text" class="small font-bold">0 / 0</span>
                    <span class="small font-bold" style="color:var(--case-accent);">SRS Lite</span>
                </div>
                <div class="progress-bg"><div id="cases-progress-bar" class="progress-fill" style="background:var(--case-accent);"></div></div>
            </div>

            <div class="card" style="max-width:800px; margin:0 auto; width:100%; flex:1; display:flex; flex-direction:column; border-top: 4px solid var(--case-accent);">
                <div class="flex-between" style="margin-bottom:12px;">
                    <div id="case-tags-container"></div>
                    <button id="case-edit-btn" class="icon-btn"><span class="material-icons" style="font-size:18px;">edit</span></button>
                </div>
                <div id="case-edit-form" style="display:none; margin-bottom:12px; padding:12px; border:1px solid var(--case-accent); border-radius:8px;">
                     <label>T√≠tulo:</label><input id="edit-case-title" class="input">
                     <label>Desc:</label><textarea id="edit-case-desc" class="input"></textarea>
                     <label>Diag:</label><textarea id="edit-case-diag" class="input"></textarea>
                     <button id="save-case-edit" class="btn small" style="background:var(--case-accent); color:white; margin-top:8px;">Guardar</button>
                </div>

                <div id="case-content-front" style="flex:1;">
                    <h2 id="case-title" style="margin-top:0;"></h2>
                    <div id="case-image-container" style="text-align:center; margin-bottom:16px;"></div>
                    <div id="case-description" style="line-height:1.6; white-space:pre-wrap;"></div>
                </div>

                <div id="case-content-back" style="display:none; margin-top:24px; padding-top:24px; border-top:1px dashed var(--border); animation:fadeIn 0.3s;">
                    <h3 style="color:var(--case-accent);">Diagn√≥stico</h3>
                    <div id="case-diagnosis" style="line-height:1.6;"></div>
                    <div style="margin-top:24px;">
                        <label class="small font-bold">Mis Apuntes</label>
                        <textarea id="case-notepad" class="notepad" placeholder="Notas..."></textarea>
                    </div>
                </div>

                <div style="margin-top:24px; padding-bottom: 20px;">
                    <button id="case-reveal-btn" class="btn" style="width:100%; padding:14px; background:var(--case-accent); color:white; font-size:1rem;">Ver Respuesta</button>
                    <div id="case-srs-controls" class="srs-controls" style="display:none;">
                        <button onclick="handleCaseSRS('hard')" class="srs-btn srs-hard"><strong>Dif√≠cil</strong> <small>Repetir ahora</small></button>
                        <button onclick="handleCaseSRS('good')" class="srs-btn srs-good"><strong>Bien</strong> <small>Al final</small></button>
                        <button onclick="handleCaseSRS('easy')" class="srs-btn srs-easy"><strong>F√°cil</strong> <small>Archivar</small></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="bank-editor-screen" class="card" style="display:none; position:absolute; inset:0; z-index:50; overflow-y:auto;">
             <div class="flex-between" style="margin-bottom:16px;">
                <h3>Editor / Filtro Avanzado</h3>
                <button onclick="$('bank-editor-screen').style.display='none'" class="btn small outline">Cerrar</button>
             </div>
             <p class="small text-muted">Selecciona tags para filtrar el banco actual.</p>
             <div id="editor-tag-filter" style="display:flex; flex-wrap:wrap; gap:6px; margin-bottom:16px;"></div>
             <div style="display:flex; gap:12px; margin-bottom:16px;">
                 <button id="start-filtered-quiz-btn" class="btn primary" style="flex:1;">Practicar Selecci√≥n</button>
                 <button id="create-filtered-bank-btn" class="btn outline" style="flex:1;">Guardar como Banco</button>
                 <button id="delete-filtered-btn" class="btn" style="background:var(--error-bg); color:var(--error-text);">Borrar</button>
             </div>
             <div id="editor-question-list" style="font-size:0.85rem;"></div>
        </div>
  </main>
</div>

<div id="drawer" class="drawer">
    <div class="flex-between" style="margin-bottom:20px;"><h3>Men√∫</h3><button onclick="$('drawer').classList.remove('open')" class="icon-btn"><span class="material-icons">close</span></button></div>
    <div style="margin-bottom:12px;"><input id="drawer-search" class="input" placeholder="Buscar..." /><div id="drawer-search-results" class="search-results"></div></div>
    <div id="nav-grid-drawer" class="nav-grid"></div>
</div>

<div id="preview-overlay" class="overlay">
  <div class="modal" style="max-width: 800px; display: flex; flex-direction: column; max-height: 85vh;">
    <div class="flex-between" style="border-bottom:1px solid var(--border); padding-bottom:12px; margin-bottom:12px;">
      <h3 style="margin:0;">Vista Previa</h3>
      <div style="display:flex; gap:8px">
        <button id="preview-save-btn" class="btn primary">Guardar Banco</button>
        <button onclick="$('preview-overlay').classList.remove('open')" class="btn outline">Cancelar</button>
      </div>
    </div>
    <div style="flex:1; overflow-y:auto; padding-right:4px;">
        <div id="preview-list"></div>
    </div>
  </div>
</div>

<div id="tutorial-overlay" class="overlay">
    <div class="modal" style="max-width:700px;">
        <div class="flex-between" style="margin-bottom:16px; border-bottom:1px solid var(--border); padding-bottom:12px;">
            <h3>Gu√≠a de Pauteo Pro</h3>
            <button onclick="$('tutorial-overlay').classList.remove('open')" class="icon-btn"><span class="material-icons">close</span></button>
        </div>
        <div class="tutorial-section">
            <div class="tutorial-title"><span class="material-icons">school</span> Modos de Estudio</div>
            <ul style="padding-left:20px; line-height:1.6;">
                <li><strong>Estudio:</strong> Feedback inmediato. Te muestra si fallaste o acertaste al instante.</li>
                <li><strong>Examen:</strong> Simulaci√≥n ciega. No ver√°s las respuestas hasta terminar el tiempo.</li>
                <li><strong>Pauteo:</strong> <span class="key-badge">Nuevo</span> Muestra la respuesta correcta marcada autom√°ticamente. Ideal para lectura r√°pida.</li>
            </ul>
        </div>
        <div class="tutorial-section">
            <div class="tutorial-title"><span class="material-icons" style="color:var(--case-accent);">medical_services</span> Casos Cl√≠nicos (SRS)</div>
            <p>Sistema de repetici√≥n espaciada para casos largos:</p>
            <ul style="padding-left:20px; line-height:1.6;">
                <li><span style="color:var(--error-text)">Dif√≠cil:</span> El caso vuelve a aparecer en 3 turnos.</li>
                <li><span style="color:#0369a1">Bien:</span> Se mueve al final de la cola.</li>
                <li><span style="color:var(--success-text)">F√°cil:</span> Se archiva por hoy.</li>
            </ul>
        </div>
        <div class="tutorial-section">
            <div class="tutorial-title"><span class="material-icons">auto_awesome</span> Inteligencia Artificial</div>
            <p>Configura tu API Key de Gemini en "Config IA" para etiquetado autom√°tico.</p>
        </div>
    </div>
</div>

<div id="templates-overlay" class="overlay">
    <div class="modal" style="max-width:650px;">
        <div class="flex-between" style="margin-bottom:16px; border-bottom:1px solid var(--border); padding-bottom:12px;">
            <h3>Formatos de Importaci√≥n</h3>
            <button onclick="$('templates-overlay').classList.remove('open')" class="icon-btn"><span class="material-icons">close</span></button>
        </div>
        <div style="margin-bottom:24px;">
            <div class="flex-between" style="margin-bottom:8px;">
                <strong style="color:var(--primary);">1. Banco de Preguntas</strong>
                <div style="display:flex; gap:8px;">
                    <button id="download-template-file-btn" class="btn small outline">Descargar .json</button>
                    <button onclick="copyToClip('code-quiz')" class="btn small outline">Copiar</button>
                </div>
            </div>
            <pre id="code-quiz" style="background:#f4f4f5; padding:12px; border-radius:8px; font-family:monospace; font-size:0.8rem; overflow-x:auto; color:#333; border:1px solid var(--border);">[
  {
    "question": "¬øTratamiento de primera l√≠nea?",
    "answers": ["Opci√≥n A", "Opci√≥n B", "Opci√≥n C"],
    "correct": 0,
    "justification": "Explicaci√≥n detallada...",
    "tags": ["Tema 1"],
    "image": "https://ejemplo.com/img.jpg" 
  }
]</pre>
        </div>
        <div>
            <div class="flex-between" style="margin-bottom:8px;">
                <strong style="color:var(--case-accent);">2. Casos Cl√≠nicos (SRS)</strong>
                <button onclick="copyToClip('code-case')" class="btn small outline">Copiar</button>
            </div>
            <pre id="code-case" style="background:#ecfdf5; padding:12px; border-radius:8px; font-family:monospace; font-size:0.8rem; overflow-x:auto; color:#064e3b; border:1px solid var(--case-accent);">[
  {
    "title": "T√≠tulo del Caso",
    "description": "Historia cl√≠nica completa...",
    "diagnosis": "Resoluci√≥n y diagn√≥stico...",
    "tags": ["Especialidad"],
    "image": ""
  }
]</pre>
        </div>
    </div>
</div>

<div id="ai-config-overlay" class="overlay">
    <div class="modal">
        <div class="flex-between"><h3>Configurar Gemini API</h3><button onclick="$('ai-config-overlay').classList.remove('open')" class="icon-btn"><span class="material-icons">close</span></button></div>
        <p class="text-muted small">Ingresa tu API Key para habilitar tags autom√°ticos.</p>
        <input id="ai-api-key" type="password" class="input" placeholder="AIzaSy..." style="margin:12px 0;">
        <button id="save-ai-key-btn" class="btn primary" style="width:100%;">Guardar Key</button>
        <div style="text-align:center; margin-top:8px;"><a href="https://aistudio.google.com/app/apikey" target="_blank" class="small" style="color:var(--primary);">Obtener Key Gratis</a></div>
    </div>
</div>

<div id="merge-overlay" class="overlay">
    <div class="modal">
        <div class="flex-between"><h3>Fusionar Bancos</h3><button onclick="$('merge-overlay').classList.remove('open')" class="icon-btn"><span class="material-icons">close</span></button></div>
        <div id="merge-list-container" style="max-height:200px; overflow:auto; margin:12px 0;"></div>
        <button id="confirm-merge-btn" class="btn primary" style="width:100%;">Fusionar</button>
    </div>
</div>

<div id="lightbox-modal" class="overlay" style="z-index:3000; background:rgba(0,0,0,0.9);">
    <span class="material-icons" style="position:absolute; top:20px; right:20px; color:white; font-size:32px; cursor:pointer;" onclick="$('lightbox-modal').classList.remove('open')">close</span>
    <img id="lightbox-img" style="max-width:95%; max-height:95vh; border-radius:8px;">
</div>

<div id="loading-overlay" class="overlay" style="z-index:4000;">
    <div class="card" style="text-align:center;">
        <div style="font-size:2rem;">‚ú®</div>
        <p class="font-bold">Procesando...</p>
        <div class="progress-bg" style="width:200px; margin:10px auto;"><div id="ai-loading-bar" class="progress-fill"></div></div>
    </div>
</div>

<script>
// --- CORE UTILS ---
const $ = (id) => document.getElementById(id);
const STORAGE_KEY = 'pauteo_state_v5';
const BANKS_KEY = 'pauteo_banks_v5';
const CASES_KEY = 'pauteo_cases_v5';
const STATS_KEY = 'pauteo_stats_v5';
const AI_KEY_STORAGE = 'pauteo_gemini_key';

let timerInterval = null; 
let deferredPrompt; // GLOBAL VARIABLE FOR PWA INSTALL

const AUTO_TAGGER = {'Cardio':['iam','infarto','ecg'],'Resp':['neumonia','epoc','asma'],'Neuro':['acv','stroke'],'Gastro':['hda','hdb','cirrosis'],'Ped':['bronquiolitis','sbo']};
function detectTags(txt) { const t=new Set(); const l=txt.toLowerCase(); for(const[k,v] of Object.entries(AUTO_TAGGER)){if(v.some(w=>l.includes(w)))t.add(k);} return Array.from(t); }

// --- STATS & SMART SHUFFLE ---
function getQuestionStats() { 
    return JSON.parse(localStorage.getItem(STATS_KEY) || '{}'); 
}
function updateQuestionStat(qid, isCorrect) {
    const stats = getQuestionStats();
    if(!stats[qid]) stats[qid] = { wrong: 0, correct: 0 };
    if(isCorrect) stats[qid].correct++; else stats[qid].wrong++;
    localStorage.setItem(STATS_KEY, JSON.stringify(stats));
}
function smartShuffleArray(array) {
    const stats = getQuestionStats();
    return array.map(q => {
        const s = stats[q.id] || { wrong: 0, correct: 0 };
        const weight = 1 + (s.wrong * 4) - (s.correct * 0.5); 
        return { q, sort: Math.random() * Math.max(0.1, weight) };
    }).sort((a, b) => b.sort - a.sort).map(item => item.q);
}

const app = { 
    questions: [], masterQuestions: [], currentIndex: 0, answersGiven: {}, marked: {}, flagged: {}, 
    mode: 'study', savedBanks: {}, activeBankName: null, 
    cases: [], casesQueue: [], currentCaseIdx: 0, caseNotes: {},
    editorQuestions: [], currentEditorFilter: {tags: new Set()}, 
    backupQuestions: null, lastPreviewArr: null
};

// --- INIT ---
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    $('download-app-btn').style.display = 'inline-flex';
});

window.addEventListener('DOMContentLoaded', () => {
    try {
        const s = JSON.parse(localStorage.getItem(STORAGE_KEY)); if(s) Object.assign(app, s);
        app.savedBanks = JSON.parse(localStorage.getItem(BANKS_KEY) || '{}');
        app.cases = JSON.parse(localStorage.getItem(CASES_KEY) || '[]');
        app.caseNotes = JSON.parse(localStorage.getItem('pauteo_case_notes') || '{}');
        // If we have an active bank name but questions array is empty, load it
        if(app.activeBankName && app.savedBanks[app.activeBankName] && (!app.questions || app.questions.length === 0)) {
            app.questions = app.savedBanks[app.activeBankName];
        }
    } catch(e){}

    if(!app.questions || !app.questions.length) app.questions = [{id:0, question:"Bienvenido. Carga un banco.", answers:["OK","Ayuda"], correct:0, tags:["Intro"]}];
    
    // UI Setup
    setTheme(localStorage.getItem('pauteo_theme')||'pink');
    function renderBanksList() {
    const listContainer = $('banks-list');
    listContainer.innerHTML = ''; // Limpiar lista actual
    
    // Obtener nombres de bancos y ordenar alfab√©ticamente
    const bankNames = Object.keys(app.savedBanks || {}).sort();

    if (bankNames.length === 0) {
        listContainer.innerHTML = '<div style="padding:8px; color:var(--muted); font-size:0.8rem; font-style:italic;">Sin bancos guardados</div>';
        return;
    }

    bankNames.forEach(name => {
        const row = document.createElement('div');
        row.className = 'flex-between';
        row.style.padding = '8px';
        row.style.borderBottom = '1px solid var(--border)';
        row.style.fontSize = '0.9rem';

        // Determinar si es el banco activo
        const isActive = (name === app.activeBankName);
        if (isActive) {
            row.style.background = 'var(--primary-soft)';
            row.style.fontWeight = '600';
            row.style.color = 'var(--primary)';
        }

        // Crear el HTML interno (Nombre + Bot√≥n Borrar)
        const count = app.savedBanks[name] ? app.savedBanks[name].length : 0;
        
        // Elemento Nombre (Clic para cargar)
        const nameSpan = document.createElement('span');
        nameSpan.textContent = `${name} (${count})`;
        nameSpan.style.cursor = 'pointer';
        nameSpan.style.flex = '1'; // Ocupar espacio disponible
        nameSpan.onclick = () => loadBank(name); // Usamos una funci√≥n auxiliar

        // Elemento Borrar
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'icon-btn';
        deleteBtn.style.width = '24px';
        deleteBtn.style.height = '24px';
        deleteBtn.style.border = 'none';
        deleteBtn.style.background = 'transparent';
        deleteBtn.innerHTML = '<span class="material-icons" style="font-size:16px; color:var(--muted);">delete</span>';
        deleteBtn.onclick = (e) => { e.stopPropagation(); deleteBank(name); };

        row.appendChild(nameSpan);
        row.appendChild(deleteBtn);
        listContainer.appendChild(row);
    });
    }

    // Funci√≥n auxiliar para cargar el banco (agr√©gala justo debajo de renderBanksList)
    function loadBank(name) {
        if (!app.savedBanks[name]) return;
        
        app.activeBankName = name;
        
        // Cargar preguntas a la sesi√≥n activa
        app.questions = [...app.savedBanks[name]];
        
        // IMPORTANTE: Actualizar tambi√©n la copia maestra para los filtros
        if (Array.isArray(app.questions)) {
            app.masterQuestions = [...app.questions]; 
        }

        saveState();
        updateHeader();
        renderBanksList(); // Re-renderizar para mostrar el activo marcado
        renderQuestion(0);
        renderStartTags(); // Actualizar tags del dashboard
        
        // Si estamos en m√≥vil, cerrar el drawer autom√°ticamente
        if ($('drawer').classList.contains('open')) {
            $('drawer').classList.remove('open');
        }
    }
    
    // Listeners
    $('file-input').onchange = handleFileUpload;
    $('cases-file-input').onchange = handleCasesUpload;
    $('search-bar').oninput = (e) => handleSearch(e.target.value, 'sidebar-search-results');
    $('drawer-search').oninput = (e) => handleSearch(e.target.value, 'drawer-search-results');
    
    $('drop-zone').onclick = () => $('file-input').click();
    $('drop-zone').ondragover = (e) => {e.preventDefault(); $('drop-zone').style.background='var(--primary-soft)'};
    $('drop-zone').ondrop = (e) => {e.preventDefault(); handleFileUpload({target:{files:e.dataTransfer.files}})};
    
    // Buttons
    $('btn-ai-config').onclick = () => $('ai-config-overlay').classList.add('open');
    $('save-ai-key-btn').onclick = saveAiKey;
    $('btn-ai-tags-bank').onclick = runAutoAI;
    $('clean-duplicates-btn').onclick = removeDuplicates;
    $('btn-merge-ui').onclick = openMergeUI;
    $('confirm-merge-btn').onclick = doMerge;
    $('export-json-btn').onclick = exportBank;
    $('tutorial-btn').onclick = () => $('tutorial-overlay').classList.add('open');
    $('btn-show-templates').onclick = () => $('templates-overlay').classList.add('open');
    
    // Bank Management Listeners (FIXED)
    $('save-bank-btn').onclick = () => {
        const name = prompt("Nombre del banco:", app.activeBankName || "Nuevo Banco");
        if(!name) return;
        app.savedBanks[name] = app.questions;
        app.activeBankName = name;
        saveBanks(); renderBanksList(); updateHeader();
        alert("Guardado exitosamente.");
    };

    $('update-bank-btn').onclick = () => {
        if(!app.activeBankName) return alert("No hay un banco activo seleccionado.");
        if(!confirm(`¬øSobreescribir banco "${app.activeBankName}" con las preguntas actuales?`)) return;
        app.savedBanks[app.activeBankName] = app.questions;
        saveBanks();
        alert(`Banco "${app.activeBankName}" actualizado.`);
    };

    // Case Reveal Listener (FIXED)
    $('case-reveal-btn').onclick = () => {
         $('case-content-back').style.display = 'block';
         $('case-reveal-btn').style.display = 'none';
         $('case-srs-controls').style.display = 'grid';
         // Scroll to see result
         const scroller = $('cases-study-screen');
         setTimeout(() => scroller.scrollTo({ top: scroller.scrollHeight, behavior: 'smooth' }), 100);
    };

    // Navigation
    $('prev-btn').onclick = () => renderQuestion(app.currentIndex - 1);
    $('next-btn').onclick = () => renderQuestion(app.currentIndex + 1);
    $('restart-btn').onclick = () => { app.answersGiven={}; renderQuestion(0); };
    $('show-results-btn').onclick = showResults;
    $('retry-incorrect-btn').onclick = retryIncorrect; // Listener for retry
    
    // Tools
    $('star-btn').onclick = toggleStar;
    $('flag-btn').onclick = toggleFlag;
    $('edit-q-btn').onclick = toggleEditQuestion;
    $('save-edit-btn').onclick = saveEditQuestion;
    
    // Filter & Smart
    $('open-editor-hero-btn').onclick = openBankEditor;
    $('create-filtered-bank-btn').onclick = createBankFromFilter;
    $('delete-filtered-btn').onclick = deleteFiltered;
    $('start-filtered-quiz-btn').onclick = startFilteredQuiz;

    // Modes
    ['study','exam','pauteo'].forEach(m => {
        $(`mode-${m}`).onclick = () => { 
            app.mode=m; app.answersGiven={}; updateModeButtons(); 
            if(document.body.classList.contains('quiz-mode')) renderQuestion(app.currentIndex);
        };
    });

    // Mobile Drawer
    $('mobile-menu-btn').onclick = () => { renderNavGrid(); $('drawer').classList.add('open'); };
    $('quiz-menu-btn').onclick = () => { renderNavGrid(); $('drawer').classList.add('open'); };

    // Smart Shuffle
    $('open-smart-btn').onclick = () => {
        if(app.questions.length === 0) return alert("Carga un banco primero.");
        app.questions = smartShuffleArray([...app.questions]); 
        startQuiz('study', false); 
        alert("üß† Modo Inteligente: Se han priorizado las preguntas que has fallado anteriormente.");
    };

    // Download Template
    $('download-template-file-btn').onclick = () => {
        const template = [{ "question": "Escribe aqu√≠ tu pregunta...", "answers": ["Alternativa A", "Alternativa B", "Alternativa C"], "correct": 0, "tags": ["Tema 1"], "justification": "Explicaci√≥n opcional." }];
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(template, null, 2));
        const dlNode = document.createElement('a'); dlNode.setAttribute("href", dataStr); dlNode.setAttribute("download", "plantilla_pauteo.json"); document.body.appendChild(dlNode); dlNode.click(); dlNode.remove();
    };

    // Timer
¬†¬†¬† $('start-exam').onclick = () => {
¬†¬†¬†¬†¬†¬†¬† const mins = parseInt($('timer-input').value) || 30;
¬†¬†¬†¬†¬†¬†¬† const countInput = $('q-count-input').value;
¬†¬†¬†¬†¬†¬†¬† const qLimit = countInput ? parseInt(countInput) : 0; // 0 significa "Todas"
¬†¬†¬†¬†¬†¬†¬† const source = (app.masterQuestions && app.masterQuestions.length) 
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† ? [...app.masterQuestions] 
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† : [...app.questions]; 
¬†¬†¬†¬†¬†¬†¬† if(source.length === 0) return alert("No hay preguntas cargadas."); 
¬†¬†¬†¬†¬†¬†¬† source.sort(() => Math.random() - 0.5); 
¬†¬†¬†¬†¬†¬†¬† if (qLimit > 0 && qLimit < source.length) {
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† app.questions = source.slice(0, qLimit);
¬†¬†¬†¬†¬†¬†¬† } else {
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† app.questions = source;
¬†¬†¬†¬†¬†¬†¬† } 

¬†¬†¬†¬†¬†¬†¬† startQuiz('exam', false); 
¬†¬†¬†¬†¬†¬†¬† if(timerInterval) clearInterval(timerInterval);
¬†¬†¬†¬†¬†¬†¬† const display = $('timer-display');
¬†¬†¬†¬†¬†¬†¬† let remaining = mins * 60;
¬†¬†¬†¬†¬†¬†¬† display.textContent = `${mins}:00`;
¬†¬†¬†¬†¬†¬†¬† display.style.color = 'var(--primary)'; 

¬†¬†¬†¬†¬†¬†¬† timerInterval = setInterval(() => {
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† remaining--;
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† const mm = String(Math.floor(remaining / 60)).padStart(2, '0');
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† const ss = String(remaining % 60).padStart(2, '0');
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† display.textContent = `${mm}:${ss}`;
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† if (remaining <= 60) display.style.color = 'var(--error-text)'; // √öltimo minuto rojo
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† 
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† if (remaining <= 0) { 
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† clearInterval(timerInterval); 
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† alert('¬°Tiempo terminado! Se mostrar√°n los resultados.'); 
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† showResults(); 
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† }
¬†¬†¬†¬†¬†¬†¬† }, 1000);
¬†¬†¬† };
});

function setTheme(t) { document.documentElement.setAttribute('data-theme', t); localStorage.setItem('pauteo_theme', t); }
function saveState() { localStorage.setItem(STORAGE_KEY, JSON.stringify({currentIndex:app.currentIndex, answersGiven:app.answersGiven, marked:app.marked, flagged:app.flagged, mode:app.mode, activeBankName:app.activeBankName})); }
function saveBanks() { localStorage.setItem(BANKS_KEY, JSON.stringify(app.savedBanks)); }
function updateModeButtons() {
    ['study','exam','pauteo'].forEach(m => {
        const b = $(`mode-${m}`);
        if(app.mode === m) b.classList.add('active-mode'); else b.classList.remove('active-mode');
    });
}
window.copyToClip = (id) => { navigator.clipboard.writeText($(id).textContent).then(()=>alert("Copiado")); };

// --- PARSING & NORMALIZATION ---
function normalizeQuestions(raw) {
    if (!Array.isArray(raw)) return [];
    return raw.map((r, i) => {
        const qText = r.question || r.text || r.enunciado || r.pregunta || '';
        const qAns = r.answers || r.options || r.alternativas || r.choices || [];
        return { 
            id: Date.now() + Math.floor(Math.random()*100000) + i, 
            question: typeof qText === 'string' ? qText.trim() : '', 
            image: r.image || r.img || null, 
            answers: Array.isArray(qAns) ? qAns : [], 
            correct: typeof r.correct === 'number' ? r.correct : 0, 
            justification: r.justification || r.explanation || '', 
            tags: (r.tags && Array.isArray(r.tags) && r.tags.length > 0) ? r.tags : detectTags(qText) 
        };
    }).filter(q => q.question && q.answers.length > 1);
}

function parseTxtToQuestions(text) { 
    const qs=[]; 
    text.split(/\n\s*\n/).forEach((b,i) => { 
        const l = b.trim().split('\n'); if(l.length < 2) return; 
        let qT="", ops=[], cor=0; 
        l.forEach(line => { 
            if(line.match(/^[a-eA-E][\)\.]/)) ops.push(line.replace(/^[a-eA-E][\)\.]\s*/,'')); 
            else if(line.match(/^R:/)) cor = line.toLowerCase().charCodeAt(2) - 97; 
            else qT += line+"\n"; 
        }); 
        if(ops.length > 1) qs.push({id: Date.now()+i, question: qT.trim(), answers: ops, correct: cor, tags: detectTags(qT)}); 
    }); 
    return qs; 
}

// --- IMPORT & PREVIEW ---
async function handleFileUpload(e) {
    const files = Array.from(e.target.files);
    if (!files.length) return;
    $('loading-overlay').classList.add('open');
    let merged = [];
    try {
        for(const f of files) { 
            const txt = await f.text(); 
            let qs = []; 
            try { qs = normalizeQuestions(JSON.parse(txt)); } catch(e){} 
            if(!qs.length) qs = parseTxtToQuestions(txt); 
            if(qs.length) merged = merged.concat(qs); 
        }

        if(merged.length) {
            if(localStorage.getItem(AI_KEY_STORAGE)) {
                if(confirm(`Detectadas ${merged.length} preguntas. ¬øUsar IA para tags? (Lento)`)) merged = await enrichQuestionsWithAI(merged);
            }
            app.lastPreviewArr = merged; 
            app.questions = merged;
            app.masterQuestions = [...merged];
            const list = $('preview-list'); list.innerHTML=''; 
            merged.forEach((q,i)=>{ 
                const d = document.createElement('div'); d.style.padding='10px'; d.style.borderBottom='1px solid var(--border)'; 
                const tagsHtml = (q.tags||[]).map(t => `<span class="tag-pill" style="font-size:0.65em; padding:2px 6px;">${t}</span>`).join('');
                d.innerHTML = `<div style="font-weight:bold; font-size:0.85rem; color:var(--primary); margin-bottom:4px;">#${i+1}</div><div style="font-size:0.9rem; margin-bottom:4px;">${q.question.substring(0,120)}${q.question.length>120?'...':''}</div><div>${tagsHtml}</div>`; 
                list.appendChild(d); 
            }); 
            $('preview-overlay').classList.add('open'); 
        } else { alert("No se detectaron preguntas v√°lidas."); }
    } catch (err) { console.error(err); alert("Error al leer archivos."); } 
    finally { $('loading-overlay').classList.remove('open'); $('file-input').value = ''; }
}

$('preview-save-btn').onclick = () => {
    if(!app.lastPreviewArr || !app.lastPreviewArr.length) return;
    
    const name = prompt("Nombre para el nuevo banco:", "Nuevo Banco");
    if(!name) return;

    if(app.savedBanks[name] && !confirm(`"${name}" ya existe. ¬øSobreescribir?`)) return;

    // Guardar en memoria y persistencia
    app.savedBanks[name] = app.lastPreviewArr;
    app.activeBankName = name;
    
    // Cargar como activo inmediatamente
    app.questions = [...app.lastPreviewArr];
    app.masterQuestions = [...app.lastPreviewArr]; // Copia maestra
    
    saveBanks();
    saveState();
    
    // ACTUALIZAR LA INTERFAZ
    renderBanksList(); 
    updateHeader();
    renderStartTags();
    renderQuestion(0);
    
    $('preview-overlay').classList.remove('open');
    alert(`Banco "${name}" guardado y cargado.`);
};

// --- QUIZ LOGIC ---
function startQuiz(mode, shuffle=false) {
    if(mode) app.mode = mode; 
    app.answersGiven = {}; app.currentIndex = 0;
    updateModeButtons();
    if(shuffle) app.questions.sort(() => Math.random() - 0.5);
    $('dashboard-view').style.display='none'; $('cases-view').style.display='none'; $('quiz-view').style.display='flex';
    document.body.classList.add('quiz-mode');
    renderQuestion(0);
}

function renderQuestion(idx) {
    if(idx<0 || idx>=app.questions.length) return;
    app.currentIndex = idx;
    const q = app.questions[idx];
    
    $('question-text').textContent = q.question;
    $('answers').innerHTML = ''; $('justification-box').style.display = 'none'; $('edit-form-container').style.display = 'none';
    $('justification-box').removeAttribute('open');

    const imgC = $('question-image-container'); imgC.innerHTML = '';
    if(q.image) { const i = document.createElement('img'); i.src = q.image; i.className = 'question-img'; i.onclick=()=>openLightbox(q.image); imgC.appendChild(i); }
    
    const tagsC = $('question-tags'); tagsC.innerHTML = '';
    (q.tags||[]).forEach(t => { const s = document.createElement('span'); s.className = 'tag-pill'; s.textContent = t; tagsC.appendChild(s); });

    q.answers.forEach((ans, i) => {
        const div = document.createElement('div'); div.className = 'answer-card';
        div.innerHTML = `<b style="opacity:0.5; margin-right:8px;">${String.fromCharCode(65+i)}</b> ${ans}`;
        const given = app.answersGiven[q.id];
        
        if(app.mode === 'pauteo') {
            div.classList.add('disabled');
            if(i === q.correct) div.classList.add('correct');
        } 
        else if(given !== undefined) {
            div.classList.add('disabled');
            if(app.mode === 'exam') { if(i===given) div.classList.add('selected-blind'); }
            else { if(i===q.correct) div.classList.add('correct'); else if(i===given) div.classList.add('incorrect'); }
        }

        div.onclick = () => { 
            if(app.mode === 'pauteo') return; 
            if(app.answersGiven[q.id]===undefined) { 
                app.answersGiven[q.id]=i; 
                // Update stats for smart shuffle
                if(app.mode !== 'exam') updateQuestionStat(q.id, i === q.correct);
                renderQuestion(idx); 
            } 
        };
        $('answers').appendChild(div);
    });

    const showJust = (app.answersGiven[q.id]!==undefined && app.mode!=='exam') || app.mode === 'pauteo';
    if(showJust) {
        $('justification-box').style.display = 'block'; 
        $('justification-text').innerHTML = q.justification||'Sin explicaci√≥n';
        if(app.mode === 'pauteo') $('justification-box').setAttribute('open', '');
    }

    $('star-btn').style.color = app.marked[q.id] ? 'var(--gold)' : 'inherit';
    updateProgress(); saveState();
}

function toggleEditQuestion() {
    const box = $('edit-form-container');
    if(box.style.display === 'block') { box.style.display = 'none'; return; }
    const q = app.questions[app.currentIndex];
    $('edit-q-text').value = q.question;
    $('edit-q-image').value = q.image || '';
    $('edit-correct-idx').value = q.correct;
    const list = $('edit-answers-list'); list.innerHTML = '';
    q.answers.forEach((a, i) => { const inp = document.createElement('input'); inp.className = 'input'; inp.value = a; list.appendChild(inp); });
    box.style.display = 'block';
}

function saveEditQuestion() {
    const q = app.questions[app.currentIndex];
    q.question = $('edit-q-text').value;
    q.image = $('edit-q-image').value;
    q.correct = parseInt($('edit-correct-idx').value);
    const inputs = $('edit-answers-list').querySelectorAll('input');
    q.answers = Array.from(inputs).map(i => i.value);
    if(app.activeBankName) { app.savedBanks[app.activeBankName] = app.questions; saveBanks(); }
    renderQuestion(app.currentIndex);
}

function showResults() {
    let corr=0; app.questions.forEach(q => { if(app.answersGiven[q.id]===q.correct) corr++; });
    $('score-text').textContent = `${corr} / ${app.questions.length}`;
    $('results-panel').style.display = 'block'; $('quiz-shell').style.display='none';
    
    // Retry Logic Button Visibility
    if(corr < app.questions.length && Object.keys(app.answersGiven).length > 0) {
        $('retry-incorrect-btn').style.display='flex';
    } else {
        $('retry-incorrect-btn').style.display='none';
    }

    const l = $('results-list'); l.innerHTML = '';
    app.questions.forEach((q, i) => {
        const d = document.createElement('div'); d.style.padding='8px'; d.style.borderBottom='1px solid #eee';
        const st = app.answersGiven[q.id]===q.correct ? '<span style="color:green">‚úî</span>' : (app.answersGiven[q.id]===undefined ? '‚ö™' : '<span style="color:red">‚úò</span>');
        d.innerHTML = `<b>${i+1}.</b> ${st} ${q.question.substring(0,50)}...`;
        l.appendChild(d);
    });
}

function retryIncorrect() {
    const wrongIds = Object.keys(app.answersGiven).filter(qid => {
        const q = app.questions.find(item => item.id == qid);
        return q && app.answersGiven[qid] !== q.correct;
    });

    if(wrongIds.length === 0) return alert("No hay errores registrados.");
    
    // Filter questions
    const wrongQs = app.questions.filter(q => wrongIds.map(Number).includes(q.id));
    
    app.questions = wrongQs;
    startQuiz('study', false);
    alert(`Reintentando ${wrongQs.length} preguntas equivocadas.`);
}

function updateProgress() { $('progress-bar').style.width = `${((app.currentIndex+1)/app.questions.length)*100}%`; $('progress-text').textContent = `${app.currentIndex+1}/${app.questions.length}`; }

// --- BANK EDITOR / FILTER ---
// --- BANK EDITOR / FILTRO AVANZADO MEJORADO ---

function openBankEditor() {
    $('bank-editor-screen').style.display = 'block';
    
    // Si masterQuestions est√° vac√≠o (ej. recarga de p√°gina), intentamos recuperarlo de questions
    if (!app.masterQuestions || app.masterQuestions.length === 0) {
        app.masterQuestions = [...app.questions];
    }

    app.currentEditorFilter.tags.clear();
    app.editorQuestions = [...app.masterQuestions]; // Empezamos con todo
    renderEditorTags(); // Renderizar tags una sola vez
    renderEditorList(); // Renderizar lista
}

function renderEditorTags() {
    const ts = new Set();
    // Extraemos tags SIEMPRE de la copia maestra para ver todas las opciones posibles
    app.masterQuestions.forEach(q => (q.tags || []).forEach(t => ts.add(t)));
    
    const tc = $('editor-tag-filter'); 
    tc.innerHTML = '';
    
    // Bot√≥n para limpiar filtros
    if (ts.size > 0) {
        const clearBtn = document.createElement('button');
        clearBtn.className = 'tag-pill';
        clearBtn.style.border = '1px solid var(--primary)';
        clearBtn.innerText = 'Limpiar Filtros';
        clearBtn.onclick = () => {
            app.currentEditorFilter.tags.clear();
            updateTagStyles();
            filterQuestions();
        };
        tc.appendChild(clearBtn);
    }

    // Renderizar botones de tags
    Array.from(ts).sort().forEach(t => {
        const b = document.createElement('button'); 
        b.className = 'tag-pill'; 
        b.dataset.tag = t; // Guardamos el tag en un data-attribute
        b.textContent = `${t}`;
        b.onclick = () => { 
            if(app.currentEditorFilter.tags.has(t)) app.currentEditorFilter.tags.delete(t); 
            else app.currentEditorFilter.tags.add(t);
            
            updateTagStyles();
            filterQuestions();
        };
        tc.appendChild(b);
    });
}

function updateTagStyles() {
    // Solo actualiza visualmente los botones sin redibujar todo (m√°s r√°pido)
    const container = $('editor-tag-filter');
    Array.from(container.children).forEach(btn => {
        const t = btn.dataset.tag;
        if (!t) return; // Ignorar bot√≥n de limpiar
        if (app.currentEditorFilter.tags.has(t)) btn.classList.add('active');
        else btn.classList.remove('active');
    });
}

function filterQuestions() {
    // Filtramos sobre la COPIA MAESTRA
    if (app.currentEditorFilter.tags.size === 0) {
        app.editorQuestions = [...app.masterQuestions];
    } else {
        app.editorQuestions = app.masterQuestions.filter(q => 
            (q.tags || []).some(tag => app.currentEditorFilter.tags.has(tag))
        );
    }
    renderEditorList();
}

function renderEditorList() {
    const lc = $('editor-question-list'); 
    lc.innerHTML = `<div style="margin-bottom:10px; font-weight:bold; color:var(--primary);">Mostrando ${app.editorQuestions.length} preguntas</div>`;
    
    app.editorQuestions.forEach((q, i) => { 
        const d = document.createElement('div'); 
        d.style.padding = '4px 0';
        d.style.borderBottom = '1px dashed #eee';
        // Mostramos tags peque√±os al lado para confirmar filtro
        const tagsStr = (q.tags||[]).join(', ');
        d.innerHTML = `<span style="color:var(--muted); font-size:0.8em;">[${tagsStr}]</span> ${q.question.substring(0, 60)}...`; 
        lc.appendChild(d); 
    });
}
function createBankFromFilter() {
    const n = prompt("Nombre nuevo banco:"); if(n) { app.savedBanks[n] = app.editorQuestions; saveBanks(); renderBanksList(); alert("Creado"); }
}
function startFilteredQuiz() {
    if(!app.editorQuestions.length) return alert("No hay preguntas con esos filtros.");
    
    // Aqu√≠ est√° el truco: app.questions es lo que usa el Quiz.
    // app.masterQuestions se mantiene intacto en el fondo.
    app.questions = [...app.editorQuestions]; 
    
    startQuiz('study', true); // True para mezclar
    $('bank-editor-screen').style.display = 'none';
}

function deleteFiltered() { if(confirm("Borrar preguntas visibles?")) { const ids = new Set(app.editorQuestions.map(q=>q.id)); app.questions = app.questions.filter(q=>!ids.has(q.id)); saveState(); if(app.activeBankName){ app.savedBanks[app.activeBankName]=app.questions; saveBanks(); } openBankEditor(); } }

// --- IA LOGIC ---
async function runAutoAI() {
    const k = localStorage.getItem(AI_KEY_STORAGE); if(!k) return alert("Falta API Key");
    $('loading-overlay').classList.add('open');
    const BATCH = 5; let list = app.mode==='cases' ? app.cases : app.questions;
    for(let i=0; i<list.length; i+=BATCH) {
        const chunk = list.slice(i, i+BATCH);
        const prompt = app.mode==='cases' ? 
            `Casos: ${chunk.map((c,x)=>`${x}: ${c.title} ${c.description.substring(0,200)}`).join('\n')}. Responde JSON {id_idx: ["tag1"]}` :
            `Preguntas: ${chunk.map((q,x)=>`${x}: ${q.question}`).join('\n')}. Responde JSON {id_idx: ["tag1"]}`;
        try {
            const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${k}`, {
                method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({contents:[{parts:[{text:prompt}]}]})
            });
            const d = await r.json();
            const json = JSON.parse(d.candidates[0].content.parts[0].text.replace(/```json|```/g,''));
            chunk.forEach((item, x) => { if(json[x]) item.tags = [...new Set([...(item.tags||[]), ...json[x]])]; });
        } catch(e){ console.log(e); }
        $('ai-loading-bar').style.width = `${((i+BATCH)/list.length)*100}%`;
    }
    if(app.mode==='cases') { localStorage.setItem(CASES_KEY, JSON.stringify(app.cases)); renderCase(); }
    else { saveState(); if(app.activeBankName) { app.savedBanks[app.activeBankName] = app.questions; saveBanks(); } renderQuestion(app.currentIndex); }
    $('loading-overlay').classList.remove('open'); alert("Listo");
}

async function enrichQuestionsWithAI(questionsList) {
    const apiKey = localStorage.getItem(AI_KEY_STORAGE);
    if (!apiKey) return questionsList;
    $('loading-overlay').classList.add('open');
    const BATCH_SIZE = 5; let processedList = JSON.parse(JSON.stringify(questionsList));
    for (let i = 0; i < processedList.length; i += BATCH_SIZE) {
        const batch = processedList.slice(i, i + BATCH_SIZE);
        const promptText = batch.map((q, idx) => `ID ${idx}: ${q.question.substring(0, 300)}`).join('\n---\n');
        const prompt = `Act√∫a como m√©dico. Asigna 1-3 tags cl√≠nicos precisos. Responde SOLO JSON { "0": ["tag1"], "1": ["tag2"] }. Preguntas:\n${promptText}`;
        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
            const data = await res.json();
            const tagsMap = JSON.parse(data.candidates?.[0]?.content?.parts?.[0]?.text.replace(/```json|```/g, '').trim());
            batch.forEach((q, idx) => { if (tagsMap[idx]) q.tags = Array.from(new Set([...(q.tags || []), ...tagsMap[idx]])); });
        } catch (e) { console.error(e); }
        $('ai-loading-bar').style.width = `${((i + BATCH_SIZE) / processedList.length) * 100}%`;
    }
    $('loading-overlay').classList.remove('open'); return processedList;
}

function saveAiKey(){ const k=$('ai-api-key').value; localStorage.setItem(AI_KEY_STORAGE, k); alert("Guardada"); $('ai-config-overlay').classList.remove('open'); }

// --- TOOLS: MERGE & DUPLICATES ---
function removeDuplicates() {
    const un = []; const map = new Map(); let count=0;
    // Updated Regex to include numbers, so "Case 1" and "Case 2" are not seen as duplicates
    app.questions.forEach(q => { const k = q.question.toLowerCase().replace(/[^a-z0-9]/g,''); if(!map.has(k)) { map.set(k, true); un.push(q); } else count++; });
    if(confirm(`Eliminar ${count} duplicados?`)) { app.questions = un; saveState(); if(app.activeBankName){ app.savedBanks[app.activeBankName]=un; saveBanks(); } alert("Limpio"); }
}
function openMergeUI() {
    const c = $('merge-list-container'); c.innerHTML='';
    Object.keys(app.savedBanks).forEach(k => { const d=document.createElement('div'); d.innerHTML=`<input type="checkbox" value="${k}"> ${k}`; c.appendChild(d); });
    $('merge-overlay').classList.add('open');
}
function doMerge() {
    const ks = Array.from($('merge-list-container').querySelectorAll('input:checked')).map(i=>i.value);
    if(ks.length<2) return alert("Elige 2+");
    let nq = []; ks.forEach(k => nq = nq.concat(app.savedBanks[k]));
    const n = prompt("Nombre fusi√≥n:"); if(n) { app.savedBanks[n]=nq; saveBanks(); renderBanksList(); $('merge-overlay').classList.remove('open'); }
}
function exportBank() {
    const b = new Blob([JSON.stringify(app.questions, null, 2)], {type:'application/json'});
    const a = document.createElement('a'); a.href=URL.createObjectURL(b); a.download='banco.json'; a.click();
}

// --- CASES ---
function openCasesModule(){ app.mode='cases'; $('dashboard-view').style.display='none'; $('cases-view').style.display='flex'; if(!app.cases.length) $('cases-import-screen').style.display='block'; else startCases(); }
function startCases(){ $('cases-import-screen').style.display='none'; $('cases-study-screen').style.display='flex'; app.casesQueue=app.cases.map((_,i)=>i).sort(()=>Math.random()-0.5); renderCase(); }
function renderCase(){
    if(!app.casesQueue.length) { alert("Fin"); return exitCasesModule(); }
    const i = app.casesQueue[0]; app.currentCaseIdx=i; const c = app.cases[i];
    $('case-title').textContent = c.title; $('case-description').textContent = c.description; $('case-diagnosis').innerHTML = c.diagnosis.replace(/\n/g,'<br>');
    $('case-edit-form').style.display='none'; $('case-content-back').style.display='none'; $('case-reveal-btn').style.display='block'; $('case-srs-controls').style.display='none';
    const imC = $('case-image-container'); imC.innerHTML=''; if(c.image){ const img=document.createElement('img'); img.src=c.image; img.style.maxHeight='250px'; img.onclick=()=>openLightbox(c.image); imC.appendChild(img); }
    const tgC = $('case-tags-container'); tgC.innerHTML=''; (c.tags||[]).forEach(t=>{const s=document.createElement('span'); s.className='tag-pill'; s.textContent=t; tgC.appendChild(s);});
    $('cases-progress-text').textContent = `Pendientes: ${app.casesQueue.length}`;
}
window.handleCaseSRS = (d) => { const c = app.casesQueue.shift(); if(d==='hard') app.casesQueue.splice(2,0,c); else if(d==='good') app.casesQueue.push(c); renderCase(); };
window.exitCasesModule = () => { app.mode='study'; $('cases-view').style.display='none'; $('dashboard-view').style.display='flex'; };
$('case-edit-btn').onclick = () => { 
    $('case-edit-form').style.display = $('case-edit-form').style.display==='none' ? 'block' : 'none';
    const c = app.cases[app.currentCaseIdx]; $('edit-case-title').value=c.title; $('edit-case-desc').value=c.description; $('edit-case-diag').value=c.diagnosis;
};
$('save-case-edit').onclick = () => { const c = app.cases[app.currentCaseIdx]; c.title=$('edit-case-title').value; c.description=$('edit-case-desc').value; c.diagnosis=$('edit-case-diag').value; localStorage.setItem(CASES_KEY, JSON.stringify(app.cases)); renderCase(); };
async function handleCasesUpload(e) { const t = await e.target.files[0].text(); app.cases=JSON.parse(t); localStorage.setItem(CASES_KEY, JSON.stringify(app.cases)); startCases(); }

// --- FILE LOAD & HELPERS ---
function renderBanksList() { 
    const listContainer = $('banks-list');
    listContainer.innerHTML = ''; 
    const bankNames = Object.keys(app.savedBanks || {}).sort();
    if (bankNames.length === 0) { listContainer.innerHTML = '<div style="padding: 12px;color:var(--muted); font-size:0.85rem;text-align:center;font-style:italic;">No hay bancos guardados.</div>';
    return;
        
    }
    bankNames.forEach(name => { 
        const row = document.createElement('div');
        row.className = 'flex-between';
        row.style.padding = '10px 8px';
        row.style.borderBottom = '1px solid var(--border)';
        row.style.cursor = 'pointer';
        row.style.borderRadius = '6px';
        row.style.marginBottom = '4px';
    if (name === app.activeBankName) {
        row.style.background = 'var(--primary-soft)';
        row.style.border = '1px solid var(--primary)';
        row.style.color = 'var(--primary)'; 
        
    }else {
        row.style.background = 'var(--card)'; // Hover effect simple
        row.onmouseenter = () => row.style.background = 'var(--bg)'; row.onmouseleave = () => row.style.background = 'var(--card)';}
    const nameContainer = document.createElement('div')
        nameContainer.style.flex = '1';
        nameContainer.style.display = 'flex';
        nameContainer.style.flexDirection = 'column';
    const qCount = app.savedBanks[name] ? app.savedBanks[name].length : 0; nameContainer.innerHTML = `<span style="font-weight:600;font-size:0.9rem;">${name}</span><span style="font-size:0.75rem;opacity:0.7;">${qCount} preguntas </span>`;
        nameContainer.onclick = () => {
            app.activeBankName = name;
            app.questions = [...app.savedBanks[name]];
            app.masterQuestions = [...app.savedBanks[name]];
            saveState();
            updateHeader();
            renderBanksList(); 
            renderQuestion(0);
            renderStartTags(); 
            if($('drawer')) $('drawer').classList.remove('open');
            };
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'icon-btn';
            deleteBtn.title = "Eliminar Banco";
            deleteBtn.style.width = '32px';
            deleteBtn.style.height = '32px';
            deleteBtn.style.color = 'var(--error-text)';
            deleteBtn.style.borderColor = 'transparent';
            deleteBtn.innerHTML = '<span class="material-icons"style="font-size:18px;">delete</span>';
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                deleteBank(name);
            };
            row.appendChild(nameContainer);
            row.appendChild(deleteBtn);
            listContainer.appendChild(row);
        });
    } 
window.deleteBank = (k) => { if(confirm("Borrar?")) { delete app.savedBanks[k]; saveBanks(); renderBanksList(); } };
function updateHeader(){ $('active-bank').textContent = app.activeBankName||'(Ninguno)'; }
function renderStartTags() {
    const c = $('start-tags-list'); 
    c.innerHTML = '';
    const ts = new Set();
    
    // Usamos masterQuestions si aplicaste el fix anterior, si no, usa questions
    const source = app.masterQuestions || app.questions;
    source.forEach(q => (q.tags || []).forEach(t => ts.add(t)));
    
    Array.from(ts).slice(0, 20).forEach(t => {
        const b = document.createElement('button');
        b.className = 'tag-pill';
        b.textContent = t;
        
        // --- AQU√ç ESTABA EL FALTANTE: Agregamos el evento click ---
        b.onclick = () => {
            openBankEditor(); // Abrir el modal (ahora visible gracias al paso 1)
            
            // Si ya implementaste mi c√≥digo anterior de "Filtro Mejorado":
            if (typeof updateTagStyles === 'function') {
                app.currentEditorFilter.tags.clear();
                app.currentEditorFilter.tags.add(t);
                updateTagStyles();
                filterQuestions();
            }
        };
        // -----------------------------------------------------------
        
        c.appendChild(b);
    });
}
function renderMarkedDashboard() { const l=$('dashboard-marked-list'); l.innerHTML=''; app.questions.forEach((q,i)=>{ if(app.marked[q.id]) { const d=document.createElement('div'); d.textContent=`#${i+1} ${q.question.substring(0,40)}`; d.className='card'; d.style.padding='8px'; d.onclick=()=>{startQuiz('study'); renderQuestion(i);}; l.appendChild(d); }}); if(l.innerHTML) $('dashboard-marked-card').style.display='block'; }
function openLightbox(s) { $('lightbox-img').src=s; $('lightbox-modal').classList.add('open'); }
function toggleStar() { app.marked[app.questions[app.currentIndex].id] = !app.marked[app.questions[app.currentIndex].id]; renderQuestion(app.currentIndex); }
function toggleFlag() { app.flagged[app.questions[app.currentIndex].id] = !app.flagged[app.questions[app.currentIndex].id]; renderQuestion(app.currentIndex); }
function handleSearch(v, tid) {
    const c=$(tid); c.innerHTML=''; c.style.display=v.length>2?'block':'none';
    if(v.length>2) { app.questions.forEach((q,i)=>{ if(q.question.toLowerCase().includes(v.toLowerCase())) { const d=document.createElement('div'); d.className='search-item'; d.textContent=`#${i+1} ${q.question.substring(0,40)}`; d.onclick=()=>{startQuiz('study'); renderQuestion(i); c.style.display='none';}; c.appendChild(d); } }); }
}
function renderNavGrid() {
    const c=$('nav-grid-drawer'); c.innerHTML='';
    app.questions.forEach((q,i)=>{ 
        const d=document.createElement('div'); d.className='nav-dot'; d.textContent=i+1;
        if(app.answersGiven[q.id]!==undefined) d.classList.add(app.answersGiven[q.id]===q.correct?'answered':'wrong');
        d.onclick=()=>{startQuiz('study'); renderQuestion(i); $('drawer').classList.remove('open');}; c.appendChild(d);
    });
}
function closeQuizView(){ 
    if(timerInterval) clearInterval(timerInterval); $('timer-display').textContent=''; 
    app.quizActive=false; $('quiz-view').style.display='none'; $('dashboard-view').style.display='flex'; document.body.classList.remove('quiz-mode'); renderStartTags(); renderMarkedDashboard(); 
}
$('open-pauteo-btn').onclick = () => startQuiz('study', true);
$('open-cases-module-btn').onclick = openCasesModule;

$('download-app-btn').onclick = async () => { 
    if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        deferredPrompt = null;
    } else {
        alert("Instala desde el men√∫ del navegador.");
    }
};

</script>
</body>
</html>